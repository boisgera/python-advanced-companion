<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="S√©bastien Boisg√©rault, MINES ParisTech" />
  <title>Le mod√®le √©pid√©miologique SIR</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <!--
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet"> 
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&display=swap" rel="stylesheet">
  <script>
      document.addEventListener("DOMContentLoaded", (event) => {
          let h3 = document.createElement("h3");
          h3.innerHTML = "Table des mati√®res";
          let toc = document.getElementById("TOC");
          toc.prepend(h3);
      });    
  </script>
  <script>
      document.addEventListener("DOMContentLoaded", (event) => {
          let elts = document.querySelectorAll('body > :not(header):not(nav)');
          let headers = [...elts].filter(elt =>  
              ["H1", "H2", "H3", "H4", "H5", "H6"].includes(elt.tagName)
          )
          for (let header of headers) {
              let anchor = document.createElement("a");
              anchor.setAttribute("href", `#${header.id}`);
              anchor.setAttribute("style", "text-decoration: None;");
              anchor.innerHTML = header.outerHTML;
              header.replaceWith(anchor);
          }
      });    
  </script>
  <script>

      function filterConsole(text) {
          let lines = text.split("\n");

          console.log(lines);

          let pythonConsole = lines && lines[0].startsWith(">>>");
          if (!pythonConsole) {
              return text + "\n\n";
          } else {
              let newLines = [];
              for (let line of lines) {
                  if (line.startsWith(">>> ") || line.startsWith("... ")) {
                      newLines.push(line.slice(4));
                  } else if (line.startsWith("...")){
                      newLines.push(line.slice(3));
                  }

              }
              return newLines.join("\n") + "\n";
          }

      }

      document.addEventListener("DOMContentLoaded", (event) => {
          let codeBlocks = document.querySelectorAll("pre.python")
          for (let codeBlock of codeBlocks) {

              let button = document.createElement("button")
              let icon = document.createElement("img");
              button.appendChild(icon)
              codeBlock.insertBefore(button, codeBlock.firstChild);

              icon.setAttribute("src", "icons/copy.svg");
              icon.setAttribute("style", "opacity: 0.5;")
              button.addEventListener('click', (event) => {
                  let text = button.nextElementSibling.textContent;
                  text = filterConsole(text);
                  navigator.clipboard.writeText(text);
              });

              codeBlock.setAttribute("style", "position: relative");
              button.setAttribute("style", 
              "position: absolute; right: 1em; top: 1em; opacity: 0.0;");

              codeBlock.addEventListener("mouseover", (event) => {
                  button.style.setProperty("transition", "opacity 0.1s ease-out");
                  button.style.setProperty("opacity", "1.0");
              });

              codeBlock.addEventListener("mouseout", (event) => {
                  button.style.setProperty("transition", "opacity 0.75s ease-out");
                  button.style.setProperty("opacity", "0.0");
              });

              button.addEventListener("mouseover", (event) => {
                  icon.style.setProperty("transition", "opacity 0.1s ease-out");
                  icon.style.setProperty("opacity", "0.75");
              })

              button.addEventListener("mouseout", (event) => {
                  icon.style.setProperty("transition", "opacity 0.75s ease-out");
                  icon.style.setProperty("opacity", "0.5");
              })


          }
      });    
  </script>
  <script>
      // TODO: replace with clickable üìñ, store inside (invis) the content ?
      document.addEventListener("DOMContentLoaded", (event) => {
          let collapse = document.querySelectorAll(".collapse")
          for (let elt of collapse) {
              let wrapper = document.createElement("div");
              let clone = elt.cloneNode(true);
              wrapper.appendChild(clone);
              elt.replaceWith(wrapper);

              wrapper.style.setProperty("height", "4.5em");
              wrapper.style.setProperty("overflow", "hidden");
              wrapper.style.setProperty("position", "relative");
              wrapper.style.setProperty("box-shadow", "rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0.1) 0px 4px 6px -1px, rgba(0, 0, 0, 0.1) 0px 2px 4px -2px")


              let overlay = document.createElement("div");
              wrapper.appendChild(overlay);
              overlay.style.setProperty("z-index", "10");
              overlay.style.setProperty("background-color", "#f8f9fa"); // "#fff5f5");
              overlay.style.setProperty("position", "absolute");
              overlay.style.setProperty("top", "0px");
              overlay.style.setProperty("left", "0px");
              overlay.style.setProperty("bottom", "0px");
              overlay.style.setProperty("right", "0px");
              
              let icon = document.createElement("img");
              let button = document.createElement("button");
              button.appendChild(icon);
              button.style.setProperty("border", "none");
              button.style.setProperty("background", "none");
              overlay.appendChild(button);
              icon.setAttribute("src", "icons/chevron-down.svg");
              overlay.style.setProperty("display", "flex");
              overlay.style.setProperty("align-items", "center");
              overlay.style.setProperty("justify-content", "center");
              overlay.style.setProperty("box-shadow", "rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0.1) 0px 4px 6px -1px, rgba(0, 0, 0, 0.1) 0px 2px 4px -2px")

              button.addEventListener('click', (event) => {
                  wrapper.replaceWith(elt)

              });


  /*
              let button = document.createElement("button")
              let icon = document.createElement("img");
              button.appendChild(icon)
              codeBlock.insertBefore(button, codeBlock.firstChild);

              icon.setAttribute("src", "icons/copy.svg");
              icon.setAttribute("style", "opacity: 0.5;")
              button.addEventListener('click', (event) => {
                  let text = button.nextElementSibling.textContent;
                  text = filterConsole(text);
                  navigator.clipboard.writeText(text);
              });

              codeBlock.setAttribute("style", "position: relative");
              button.setAttribute("style", 
              "position: absolute; right: 1em; top: 1em; opacity: 0.0;");

              codeBlock.addEventListener("mouseover", (event) => {
                  button.style.setProperty("transition", "opacity 0.1s ease-out");
                  button.style.setProperty("opacity", "1.0");
              });

              codeBlock.addEventListener("mouseout", (event) => {
                  button.style.setProperty("transition", "opacity 0.75s ease-out");
                  button.style.setProperty("opacity", "0.0");
              });

              button.addEventListener("mouseover", (event) => {
                  icon.style.setProperty("transition", "opacity 0.1s ease-out");
                  icon.style.setProperty("opacity", "0.75");
              })

              button.addEventListener("mouseout", (event) => {
                  icon.style.setProperty("transition", "opacity 0.75s ease-out");
                  icon.style.setProperty("opacity", "0.5");
              })
  */

          }
      });    
  </script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Le mod√®le √©pid√©miologique SIR</h1>
<p class="author">S√©bastien Boisg√©rault, MINES ParisTech</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#todo">TODO</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#d√©pendances">D√©pendances</a></li>
<li><a href="#stuff">Stuff</a></li>
<li><a href="#mod√®les-compartimentaux">Mod√®les compartimentaux</a></li>
</ul>
</nav>
<h2 id="todo">TODO</h2>
<ul>
<li><p>function as an arg (solve_ivp)</p></li>
<li><p>investigate default values</p></li>
<li><p>use of kwargs (large option set)</p></li>
<li><p>function as a return value (dense_output)</p></li>
<li><p>autograd jacobian</p></li>
<li><p>function as an arg 2 (events). + Higher-order : optional level</p></li>
<li><p>function factory (mod√®le √† compartiment)</p></li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>Le mod√®le √©pid√©miologique √† compartiments SIR d√©termine l‚Äô√©volution dans le temps, parmi une population suppos√©e constante de <span class="math inline">\(N\)</span> individus, du nombre d‚Äôindividus susceptibles d'√™tre infect√©s <span class="math inline">\(S\)</span>, du nombre d‚Äôindividus infect√©s <span class="math inline">\(I\)</span> et du nombre d‚Äôindividus en r√©mission (n‚Äôayant plus de sympt√¥mes cliniques) <span class="math inline">\(R\)</span> (cf.¬†<a href="https://www.nature.com/articles/s41592-020-0856-2">‚ÄúThe SEIRS model for infectious disease dynamics‚Äù</a> pour la pr√©sentation d‚Äôun mod√®le plus complet).</p>
<p>Le param√®tre <span class="math inline">\(\beta&gt;0\)</span> repr√©sente le taux de contagion, <span class="math inline">\(\gamma&gt;0\)</span> le taux de gu√©rison et <span class="math inline">\(\omega&gt;0\)</span> le taux de perte d‚Äôimmunit√© (ces grandeurs sont homog√®nes √† l‚Äôinverse d'un temps). On d√©finit le nombre de reproduction de base <span class="math inline">\(R_0\)</span> par</p>
<p><span class="math display">\[
R_0 := \frac{\beta}{\gamma}
\]</span></p>
<p>En l'absence de naissances et de morts, ces grandeurs √©voluent selon les √©quations :</p>
<p><span class="math display">\[
\dot{S}(t) = \omega R(t) - \beta \frac{I(t)S(t)}{N} 
\]</span></p>
<p><span class="math display">\[
\dot{I}(t) = \beta \frac{I(t)S(t)}{N} - \gamma  I(t) 
\]</span></p>
<p><span class="math display">\[
\dot{R}(t) = \gamma I(t) - \omega R(t)
\]</span></p>
<h2 id="d√©pendances">D√©pendances</h2>
<p>Python 3, NumPy, SciPy, Matplotlib.</p>
<pre class="python"><code>from numpy import *
from numpy.linalg import *
from matplotlib.pyplot import *
from scipy.integrate import solve_ivp
import matplotlib.pyplot as plt</code></pre>
<h2 id="stuff">Stuff</h2>
<p>üìñ <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.solve_ivp.html"><code>scipy.integrate.solve_ivp</code></a></p>
<pre class="python"><code>WEEK = 7
YEAR = 365</code></pre>
<pre class="python"><code>N = 100
beta = 1 / (WEEK)
gamma = 1 / (2 * WEEK)
omega = 1 / YEAR</code></pre>
<pre class="python"><code>def dSIR(t, SIR):
    S, I, R = SIR
    dS = omega * R - beta * I * S / N
    dI = beta * I * S / N - gamma * I
    dR = gamma * I - omega * R  
    return (dS, dI, dR)</code></pre>
<pre class="python"><code>S0, I0 = 99.0, 1.0
R0 = N - S0 - I0
t_span = [0.0, 5*YEAR]
results = solve_ivp(dSIR, t_span=t_span, y0=(S0, I0, R0))
t, y = results.t, results.y</code></pre>
<pre class="python"><code>plt.figure()
plt.plot(t, y, &quot;+&quot;)
plt.show()</code></pre>
<h2 id="mod√®les-compartimentaux">Mod√®les compartimentaux</h2>
<p>(Difficult√©: üíÄüíÄüíÄ)</p>
<p>Vous avez sans doute remarqu√© que la dynamique du mod√®le SIR est enti√®rement d√©termin√©e par les flux existant entre les ‚Äúcompartiments‚Äù de population <span class="math inline">\(S\)</span>, <span class="math inline">\(I\)</span> et <span class="math inline">\(R\)</span>, qui peuvent √™tre d√©crits par la structure :</p>
<pre class="python"><code>SIR_dynamics = {
 (&quot;S&quot;, &quot;I&quot;): &quot;beta * I * S / N&quot;,
 (&quot;I&quot;, &quot;R&quot;): &quot;gamma * I&quot;,
 (&quot;R&quot;, &quot;S&quot;): &quot;omega * R&quot;
}</code></pre>
<p>Au lieu d‚Äô√©crire ‚Äú√† la main‚Äù la fonction <code>dSIR</code> comme pr√©c√©demment, on peut d√©finir une fonction <code>make_d_state</code> qui prend comme argument le type de dictionnaire ci-dessus et produit automatiquement la fonction <code>dSIR_auto</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> :</p>
<pre class="python"><code>dSIR_manu = dSIR
dSIR_auto = make_dstate(SIR_dynamics)</code></pre>
<p>On v√©rifiera que les comportements de la version manuelle et automatique sont identiques. Par exemple :</p>
<pre class="python"><code>&gt;&gt;&gt; dSIR_manu(0.0, (1/3, 1/3, 1/3))
(0.0007545118504022613, -0.023650793650793648, 0.02289628180039139)
&gt;&gt;&gt; dSIR_auto(0.0, (1/3, 1/3, 1/3))
(0.0007545118504022613, -0.023650793650793648, 0.02289628180039139)</code></pre>
<h4 id="solution">Solution</h4>
<div class="collapse">
<pre class="python"><code>def make_dstate(dynamics):
    vars = []
    for s, t in dynamics.keys():
        if s not in vars:
            vars.append(s)
        if t not in vars:
            vars.append(t)
    n = len(vars)
    
    def fun(t, state):
        ns = globals().copy()
        for var, value in zip(vars, state):
            ns[var] = value
        dstate = []
        for i in range(n):
            d = 0
            var = vars[i]
            for (edge, expr) in dynamics.items():
                source, target = edge
                if source == var:
                    d -= eval(expr, ns)
                if target == var:
                    d += eval(expr, ns)
            dstate.append(d)
        return dstate
        
    return fun </code></pre>
</div>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>on peut ainsi √©viter les erreurs dans la traduction du mod√®le de flux en √©quations diff√©rentielles, d√©finir plus rapidement de nouveaux mod√®les compartimentaux, etc.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section>
</body>
</html>
